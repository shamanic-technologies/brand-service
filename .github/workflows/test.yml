name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build TypeScript
        run: pnpm run build

      - name: Run build sanity tests (no legacy imports)
        run: pnpm run test:build

  test:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Run unit tests
        run: pnpm run test:unit
        env:
          BRAND_SERVICE_API_KEY: test-secret-key
          COMPANY_SERVICE_API_KEY: test-secret-key
          GEMINI_API_KEY: test-gemini-key
          SCRAPING_SERVICE_URL: http://localhost:3010
          SCRAPING_SERVICE_API_KEY: test-scraping-key

      - name: Run integration tests
        run: pnpm run test:integration
        env:
          BRAND_SERVICE_DATABASE_URL: ${{ secrets.BRAND_SERVICE_DATABASE_URL }}
          COMPANY_SERVICE_DATABASE_URL: ${{ secrets.COMPANY_SERVICE_DATABASE_URL }}
          BRAND_SERVICE_API_KEY: test-secret-key
          COMPANY_SERVICE_API_KEY: test-secret-key
          GEMINI_API_KEY: test-gemini-key
          SCRAPING_SERVICE_URL: http://localhost:3010
          SCRAPING_SERVICE_API_KEY: test-scraping-key

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/coverage-final.json
          fail_ci_if_error: false

  test-coverage-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for missing tests
        run: |
          BASE=${{ github.event.pull_request.base.sha }}
          HEAD=${{ github.event.pull_request.head.sha }}

          SRC_CHANGED=$(git diff --name-only "$BASE" "$HEAD" | grep -E '^src/(routes|services|middleware|db)/' | grep -v '\.d\.ts$' || true)
          TEST_CHANGED=$(git diff --name-only "$BASE" "$HEAD" | grep -E '^tests/' || true)

          if [ -n "$SRC_CHANGED" ] && [ -z "$TEST_CHANGED" ]; then
            echo "::error::Source files changed but no tests were added or updated."
            echo ""
            echo "Changed source files:"
            echo "$SRC_CHANGED"
            echo ""
            echo "Every change MUST include corresponding tests. Add unit tests in tests/unit/ or integration tests in tests/integration/."
            echo "SRC_FILES<<EOF" >> "$GITHUB_ENV"
            echo "$SRC_CHANGED" >> "$GITHUB_ENV"
            echo "EOF" >> "$GITHUB_ENV"
            echo "MISSING_TESTS=true" >> "$GITHUB_ENV"
            exit 1
          else
            echo "Test coverage check passed."
          fi

      - name: Comment on PR if tests are missing
        if: failure() && env.MISSING_TESTS == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const files = process.env.SRC_FILES;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `**Tests required** - Source files changed but no tests were added or updated:\n\`\`\`\n${files}\n\`\`\`\nEvery change must include corresponding tests (unit in \`tests/unit/\` or integration in \`tests/integration/\`).`
            });

  readme-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if README needs updating
        run: |
          BASE=${{ github.event.pull_request.base.sha }}
          HEAD=${{ github.event.pull_request.head.sha }}

          TRIGGER_FILES=$(git diff --name-only "$BASE" "$HEAD" | grep -E '^(src/routes/|src/db/schema\.ts|src/index\.ts|\.env\.example|package\.json|\.github/workflows/)' || true)
          README_CHANGED=$(git diff --name-only "$BASE" "$HEAD" | grep -E '^README\.md$' || true)

          if [ -n "$TRIGGER_FILES" ] && [ -z "$README_CHANGED" ]; then
            echo "::warning::README.md may need updating. These files changed but README.md was not touched:"
            echo "$TRIGGER_FILES"
            echo ""
            echo "NEEDS_UPDATE=true" >> "$GITHUB_ENV"
            echo "CHANGED_FILES<<EOF" >> "$GITHUB_ENV"
            echo "$TRIGGER_FILES" >> "$GITHUB_ENV"
            echo "EOF" >> "$GITHUB_ENV"
          else
            echo "README check passed."
          fi

      - name: Comment on PR if README may be stale
        if: env.NEEDS_UPDATE == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const files = process.env.CHANGED_FILES;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `⚠️ **README may need updating**\n\nThe following files changed but \`README.md\` was not updated:\n\`\`\`\n${files}\n\`\`\`\nPlease check if the README sections (API Endpoints, Scripts, Database, Environment Variables, etc.) need to reflect these changes.`
            });
